# Buffer
ArrayBuffer 对象用来表示通用的、固定长度的原始二进制数据缓冲区，是一个字节数组，可读但不可直接写。

Buffer 是 Node.JS 中用于操作 ArrayBuffer 的视图，是 TypedArray的一种。
## 内存分配机制

由于 Buffer 需要处理的是大量的二进制数据，假如用一点就向系统去申请，则会造成频繁的向系统申请内存调用，所以 Buffer 所占用的内存不是由 V8 分配，

而是在 Node.js 的 C++ 层面完成申请，在 JavaScript 中进行内存分配。这部分内存称之为堆外内存。


V8是Node的JavaScript执行引擎，V8引擎实际是一个高性能虚拟机。Node在JavaScript的执行直接受益于V8，可以随着V8的升级就能享受更好的性能或新的语言特性（如ES5和ES6）

对于一般的后端开发语言，基本内存使用是没有限制的，但是在Node中通过javaScript使用内存时只能使用部分内存（64位系统下约为1.4G，32位系统下约为0.6G）

Node基于V8构建，所以在Node中使用javaScript基本都是通过V8自己的方式进行分配和管理的。

但是Node的内存并不完全是通过V8进行分配管理的。查看内存使用情况的时候，发现堆中的内存用量总是小于进程的常驻内存用量rss。

Node中的内存使用并非都是通过V8进行分配的，还有一些不是通过V8进行分配的对象，我们称之为堆外内存

V8中，所有的javaScript对象都是通过堆来进行分配的。V8的堆内存包括heapToal（已经申请到的堆内存），

heapUsed(当前使用的堆内存)；我们在代码中声明变量并赋值的时候，所使用的对象的内存就分配在堆中。如果已申请的堆空闲内存不够分配新的对象，将继续申请堆内存，直到堆的大小超过V8的限制为止。

## 字节序

计算机硬件有两种储存数据的方式：大端字节序（big endian）和小端字节序（little endian）。

举例来说，数值0x2211使用两个字节储存：高位字节是0x22，低位字节是0x11。


+ 大端字节序：高位字节在前，低位字节在后，这是人类读写数值的方法。
+ 小端字节序：低位字节在前，高位字节在后，即以0x1122形式储存。

计算机电路先处理低位字节，效率比较高，因为计算都是从低位开始的。所以，计算机的内部处理都是小端字节序。

但是，人类还是习惯读写大端字节序。所以，除了计算机的内部处理，其他的场合几乎都是大端字节序，比如网络传输和文件储存。

计算机处理字节序的时候，不知道什么是高位字节，什么是低位字节。它只知道按顺序读取字节，先读第一个字节，再读第二个字节。

如果是大端字节序，先读到的就是高位字节，后读到的就是低位字节。小端字节序正好相反。

理解这一点，才能理解计算机如何处理字节序。

***只有读取的时候，才必须区分字节序，其他情况都不用考虑。***

处理器读取外部数据的时候，必须知道数据的字节序，将其转成正确的值。然后，就正常使用这个值，完全不用再考虑字节序。

即使是向外部设备写入数据，也不用考虑字节序，正常写入一个值即可。外部设备会自己处理字节序的问题。

``` javascript
// 举例来说，处理器读入一个16位整数。如果是大端字节序，就按下面的方式转成值。
x = buf[offset] * 256
// 上面代码中，buf是整个数据块在内存中的起始地址，offset是当前正在读取的位置。第一个字节乘以256，再加上第二个字节，就是大端字节序的值，这个式子可以用逻辑运算符改写。
x = buf[offset]<<8 | buf[offset+1];
// 上面代码中，第一个字节左移8位（即后面添8个0），然后再与第二个字节进行或运算。如果是小端字节序，用下面的公式转成值。
x = buf[offset+1] * 256 + buf[offset];
// 32位整数的求值公式也是一样的。
/* 大端字节序 */
i = (data[3]<<0) | (data[2]<<8) | (data[1]<<16) | (data[0]<<24);
/* 小端字节序 */
i = (data[0]<<0) | (data[1]<<8) | (data[2]<<16) | (data[3]<<24);
```

## 

``` javascript
// 拷贝内存
const buf1 = Buffer.from("buffer");
const buf2 = Buffer.from(buf1); // 拷贝参数中buffer的数据到新的实例
buf1[0]++;

console.log(buf1.toString()); // output: cuffer
console.log(buf2.toString()); // output: buffer

// 共享内存
const arr = new Uint8Array(1);
arr[0] = 97;

const buf = Buffer.from(arr.buffer);
console.log(buf.toString()); // output: a

arr[0] = 98;
console.log(buf.toString()); // output: b
```